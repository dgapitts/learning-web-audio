<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Synthesiser</title>

  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Material+Icons">
  <link rel="stylesheet" href="bootstrap-material-design.min.css">
  <style>
    ul {
      padding-left: 0;
    }

    ul li {
      list-style: none;
    }

    #synthesiserForm {
      margin-top: 2em;
    }

    #playButton {
      margin: 3em 0 2em;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <h1 class="navbar-brand">
      Synthesiser
    </h1>
    <div class="navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item">
          <a class="nav-link" href="1-sawtooth-wave.html">Wave</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="2-chromatic-scale.html">scale</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="3-short-sequence.html">Notes</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="4-add-a-high-pass-filter.html">Filter</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="5-modulate-filter-cutoff.html">Cutoff</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="6-add-an-envelope.html">Envelope</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="7-vibrato.html">Vibrato</a>
        </li>
      </ul>
    </div>
  </nav>

  <div class="container">
    <form id="synthesiserForm" action="#">
      <div class="form-group">
        <label for="frequencyRangeInput" class="bmd-label-static">
          Frequency: <span id="frequencyNumber"></span> Herz
        </label>
        <input type="range" class="form-control" id="frequencyRangeInput" value="440" min="55" max="1760" step="0.01">
      </div>

      <div class="form-group">
        <label for="delayRangeInput" class="bmd-label-static">
          Delay: <span id="delayNumber"></span> second
        </label>
        <input type="range" class="form-control" id="delayRangeInput" value="0" min="0" max="1" step="0.01">
      </div>

      <div class="form-group">
        <label for="durationRangeInput" class="bmd-label-static">
          Duration: <span id="durationNumber"></span> seconds
        </label>
        <input type="range" class="form-control" id="durationRangeInput" value="0.2" min="0" max="5" step="0.01">
      </div>

      <div class="form-group">
        <label for="oscillatorType" class="bmd-label-static">
          Oscillator type
        </label>
        <select name="oscillatorType" id="oscillatorType" class="btn btn-raised btn-secondary">
          <option value="triangle">Triangle</option>
          <option value="sawtooth">Sawtooth</option>
          <option value="square">Square</option>
          <option value="sine">Sine</option>
        </select>
      </div>

      <label for="enableBiquad" class="header">
        <input type="checkbox" id="enableBiquad">
        <strong>Biquad Filter</strong>
      </label>
      <fieldset id="biquadFieldset" style="display: none;">
        <div class="form-group">
          <label for="biquadFilterType" class="bmd-label-static">Filter type</label>
          <select name="biquadFilterType" id="biquadFilterType" class="btn btn-raised btn-secondary">
            <option value="bandpass">Bandpass</option>
            <option value="lowpass">Lowpass</option>
            <option value="highpass">Highpass</option>
            <option value="lowshelf">Lowshelf</option>
            <option value="highshelf">Highshelf</option>
            <option value="peaking">Peaking</option>
            <option value="notch">Notch</option>
            <option value="allpass">Allpass</option>
          </select>
        </div>
        <div class="form-group">
          <label for="biquadFilterFrequencyRangeInput" class="bmd-label-static">
            Filter frequency: <span id="biquadFilterFrequencyNumber"></span> Herz
          </label>
          <input type="range" class="form-control" id="biquadFilterFrequencyRangeInput" value="10000" min="0" max="24000" step="10">
        </div>
        <div class="form-group">
          <label for="biquadFilterLinearRampRangeInput" class="bmd-label-static">
            Linear ramp: <span id="biquadFilterLinearRampNumber"></span> Herz
          </label>
          <input type="range" class="form-control" id="biquadFilterLinearRampRangeInput" value="440" min="55" max="1760" step="0.01">
        </div>
      </fieldset>

      <label for="enableGain">
        <input type="checkbox" id="enableGain">
        <strong>Gain (envelope)</strong>
      </label>
      <fieldset id="gainFieldset" style="display: none;">
        <div class="form-group">
          <label for="gainTarget" class="bmd-label-static">Start target</label>
          <input type="number" id="gainStartTarget" value="2">
        </div>
        <div class="form-group">
          <label for="gainTimeConstant" class="bmd-label-static">Start time constant</label>
          <input type="number" id="gainStartTimeConstant" value="0.2">
        </div>
        <div class="form-group">
          <label for="gainTarget" class="bmd-label-static">End target</label>
          <input type="number" id="gainEndTarget" value="0">
        </div>
        <div class="form-group">
          <label for="gainTimeConstant" class="bmd-label-static">End time constant</label>
          <input type="number" id="gainEndTimeConstant" value="0.2">
        </div>
      </fieldset>
  
      <p class="form-group">
        <button id="playButton" class="btn btn-raised btn-primary">Play</button>
      </p>
    </form>
    <p>Tutorials: <a href="http://mmckegg.github.io/web-audio-school/">web-audio-school</a></p>
  </div>

  <script>
    const form = document.getElementById('synthesiserForm');

    const frequencyNumber = document.getElementById('frequencyNumber');
    const frequencyRangeInput = document.getElementById('frequencyRangeInput');
    frequencyNumber.innerText = frequencyRangeInput.value;
    frequencyRangeInput.addEventListener('change', (e) => frequencyNumber.innerText = e.target.value);

    const delayNumber = document.getElementById('delayNumber');
    const delayRangeInput = document.getElementById('delayRangeInput');
    delayNumber.innerText = delayRangeInput.value;
    delayRangeInput.addEventListener('change', (e) => delayNumber.innerText = e.target.value);

    const durationNumber = document.getElementById('durationNumber');
    const durationRangeInput = document.getElementById('durationRangeInput');
    durationNumber.innerText = durationRangeInput.value;
    durationRangeInput.addEventListener('change', (e) => durationNumber.innerText = e.target.value);

    const oscillatorType = document.getElementById('oscillatorType');

    const biquadFieldset = document.getElementById('biquadFieldset');
    const enableBiquad = document.getElementById('enableBiquad');
    enableBiquad.addEventListener('change', (e) => biquadFieldset.style.display = (e.target.checked) ? 'block' : 'none');

    const biquadFilterType = document.getElementById('biquadFilterType');
    const biquadFilterFrequencyRangeInput = document.getElementById('biquadFilterFrequencyRangeInput');
    const biquadFilterFrequencyNumber = document.getElementById('biquadFilterFrequencyNumber');
    biquadFilterFrequencyNumber.innerText = biquadFilterFrequencyRangeInput.value;
    biquadFilterFrequencyRangeInput.addEventListener('change', (e) => biquadFilterFrequencyNumber.innerText = e.target.value);

    const biquadFilterLinearRampNumber = document.getElementById('biquadFilterLinearRampNumber');
    const biquadFilterLinearRampRangeInput = document.getElementById('biquadFilterLinearRampRangeInput');
    biquadFilterLinearRampNumber.innerText = biquadFilterLinearRampRangeInput.value;
    biquadFilterLinearRampRangeInput.addEventListener('change', (e) => biquadFilterLinearRampNumber.innerText = e.target.value);

    const gainFieldset = document.getElementById('gainFieldset');
    const enableGain = document.getElementById('enableGain');
    enableGain.addEventListener('change', (e) => gainFieldset.style.display = (e.target.checked) ? 'block' : 'none');

    const gainStartTarget = document.getElementById('gainStartTarget');
    const gainStartTimeConstant = document.getElementById('gainStartTimeConstant');
    const gainEndTarget = document.getElementById('gainEndTarget');
    const gainEndTimeConstant = document.getElementById('gainEndTimeConstant');

    const playButton = document.getElementById('playButton');

    form.addEventListener('submit', (e) => e.preventDefault());

    const play = () => {
      const audioContext = new (AudioContext || window.webkitAudioContext)();
      
      const delay = parseFloat(delayRangeInput.value);
      const pitch = parseFloat(frequencyRangeInput.value);
      const duration = parseFloat(durationRangeInput.value);
      const biquadFrequency = parseFloat(biquadFilterFrequencyRangeInput.value);
      const biquadRamp = parseFloat(biquadFilterLinearRampRangeInput.value);

      const gainST = parseFloat(gainStartTarget.value);
      const gainSTC = parseFloat(gainStartTimeConstant.value);
      const gainET = parseFloat(gainEndTarget.value);
      const gainETC = parseFloat(gainEndTimeConstant.value);

      const startTime = audioContext.currentTime + delay;
      const endTime = startTime + duration;

      const oscillator = audioContext.createOscillator();

      let filter;
      if (enableBiquad.checked) {
        filter = audioContext.createBiquadFilter();
        filter.type = biquadFilterType.value;
        filter.frequency.setValueAtTime(biquadFrequency, startTime);
        filter.frequency.linearRampToValueAtTime(biquadRamp, endTime);
      }

      let amp;
      if (enableGain.checked) {
        amp = audioContext.createGain();
        amp.gain.value = 0;
        amp.gain.setTargetAtTime(gainST, startTime, gainSTC);
        amp.gain.setTargetAtTime(gainET, endTime, gainETC);
      }

      if (enableBiquad.checked && enableGain.checked) {
        filter.connect(audioContext.destination);
        amp.connect(filter);
        oscillator.connect(amp);
      }

      if (enableBiquad.checked && !enableGain.checked) {
        filter.connect(audioContext.destination);
        oscillator.connect(filter);
      }

      if (!enableBiquad.checked && enableGain.checked) {
        amp.connect(audioContext.destination);
        oscillator.connect(amp);
      }

      if (!enableBiquad.checked && !enableGain.checked) {
        oscillator.connect(audioContext.destination);
      }

      oscillator.type = oscillatorType.value;
      oscillator.frequency.value = pitch;

      oscillator.start(startTime);
      oscillator.stop(endTime + parseFloat((enableGain.checked) ? gainST : 0));
    };

    playButton.addEventListener('click', play);
  </script>
</body>
</html>